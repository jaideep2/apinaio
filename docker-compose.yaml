version: "3.8"

x-app-defaults: &app-defaults
  restart: always
  networks:
    - apinaio
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: 1
            capabilities: [gpu]

services:
  ollama:
    <<: *app-defaults
    container_name: ollama
    image: ollama/ollama:latest
    build:
      context: ./config/ollama
      dockerfile: Dockerfile
    ports:
        - "11434:11434"
    volumes:
      - ./workspace/ollama:/app
  
  comfyui:
    <<: *app-defaults
    container_name: comfyui
    image: ghcr.io/ai-dock/comfyui:latest-cuda
    security_opt:
      # For Rclone mount
      - apparmor:unconfined
    cap_add:
      # For Rclone mount
      - SYS_ADMIN
    devices:
      # For Rclone mount
      - "/dev/fuse:/dev/fuse"
    volumes:
      # For Rclone mount
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - ./config/rclone:/etc/rclone
      # Workspace
      - ./workspace:${WORKSPACE:-/workspace/}:rshared
      # Will echo to root-owned authorized_keys file;
      # Avoids changing local file owner
      - ./config/authorized_keys:/root/.ssh/authorized_keys_mount
      - ./config/provisioning/provisioning.sh:/opt/ai-dock/bin/provisioning.sh
      - ./config/provisioning/models.csv:/opt/ai-dock/bin/models.csv
      - ./config/provisioning/nodes.csv:/opt/ai-dock/bin/nodes.csv
    ports:
      # SSH available on host machine port 2222 to avoid conflict. Change to suit
      - ${SSH_PORT_HOST:-2222}:${SSH_PORT:-22}
      # redirect to Cloudflare quick tunnel
      - ${REDIRECTOR_PORT_HOST}:1111
      # Websocket log viewer
      - ${LOG_VIEWER_PORT_HOST}:1122
      # ComfyUI web interface
      - ${COMFYUI_PORT_HOST:-8188}:${COMFYUI_PORT:-8188}
      # Jupyter server
      #- ${JUPYTER_PORT_HOST:-8888}:${JUPYTER_PORT:-8888}
      # Rclone webserver for interactive configuration
      - ${RCLONE_PORT_HOST:-53682}:53682
    environment:
      # Don't enclose values in quotes
      - COMFYUI_BRANCH=${COMFYUI_BRANCH:-master}
      - COMFYUI_FLAGS=${COMFYUI_FLAGS:-}
      - COMFYUI_PORT=${COMFYUI_PORT:-8188}
      #- JUPYTER_MODE=${JUPYTER_MODE:-lab}
      # Allows running true SSH alongside provider proxy SSH
      - SSH_PORT=${SSH_PORT:-22}
      - WORKSPACE=${WORKSPACE:-/workspace}
      - WORKSPACE_SYNC=${WORKSPACE_SYNC}
      #- CF_TUNNEL_TOKEN=${CF_TUNNEL_TOKEN:-}
      #- CF_QUICK_TUNNELS=${CF_QUICK_TUNNELS:-true}
      - WEB_ENABLE_AUTH=${WEB_ENABLE_AUTH}
      - WEB_USER=${WEB_USER}
      - WEB_PASSWORD=${WEB_PASSWORD}
      - PROVISIONING_SCRIPT=${PROVISIONING_SCRIPT:-}
    depends_on:
      - ollama

  ffmpeg:
    <<: *app-defaults
    container_name: ffmpeg
    image: ghcr.io/jrottenberg/ffmpeg/5.0.1-ubuntu2004:latest
    volumes:
      - ./workspace/ffmpeg:${WORKSPACE:-/workspace/}
    depends_on:
      - comfyui