FROM mwader/static-ffmpeg:latest AS ffmpeg-static

FROM python:3.10-slim as base
ENV PYTHONIOENCODING=UTF-8

# Install ffmpeg
COPY --from=ffmpeg-static /ffmpeg /usr/local/bin/
COPY --from=ffmpeg-static /ffprobe /usr/local/bin/

RUN rm -f /etc/apt/apt.conf.d/docker-clean
RUN echo 'Binary::apt::APT::Keep-Downloaded-Packages "true";' > /etc/apt/apt.conf.d/keep-cache
RUN --mount=type=cache,target=/var/lib/apt,sharing=locked \
    --mount=type=cache,target=/var/cache/apt,sharing=locked \
    apt-get update \
    && apt-get --no-install-recommends install -y git

# Install Python dependencies
RUN pip install ffmpeg-python

# Copy the custom entry point script into the container
COPY entrypoint.sh /app/entrypoint.sh

# Make the script executable
RUN chmod +x /app/entrypoint.sh

# Set the working directory within the container
WORKDIR /app
